---
import {getLangFromUrl, useTranslations} from '../../../i18n/utils'
import {getPhotoDetailsStaticPaths} from '../../../util/details-static-paths'
import Layout from '../../../layouts/Layout.astro'
import {type CollectionEntry} from 'astro:content'
import {Image} from 'astro:assets'
import {type ClientProject, type CollectionItem} from '../../../content/config'
import {ArrowLeft} from 'lucide-react'
import {Button} from '../../../components/ui/button'

interface Props {
    project: CollectionEntry<'client-projects'>
}

const {project: projectProp} = Astro.props

const project: CollectionItem<ClientProject> = projectProp as unknown as CollectionItem<ClientProject>
const projectData: ClientProject = project.data

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)

export async function getStaticPaths() {
    return getPhotoDetailsStaticPaths()
}
---

<Layout title="Preview">
    <div class="flex h-full flex-col items-center justify-center gap-8 px-4 pb-12 sm:px-8 max-w-[90rem] mx-auto">
        <header class="self-start pt-8">
            <Button id="go-back-button" variant="ghost">
                <div class="flex items-center gap-2">
                    <ArrowLeft/>
                    <span>{t('common.back')}</span>
                </div>
            </Button>
        </header>

        <section
                class="flex flex-col-reverse sm:flex-row w-full flex-1 items-center sm:items-start gap-8 bg-gray-50 p-4 shadow-xl">
            <Image
                    src={projectData.titleImage as unknown as string}
                    alt=""
                    transition:name=`media-image-${project.slug}`
                    width="300"
                    height="400"
                    class="object-contain"
            />

            <div class="flex flex-col gap-2">
                <h1 class="layout-title" transition:name=`project-heading-${project.slug}`>
                    {projectData.title}
                </h1>
                <p class="secondary-text max-w-xl text-pretty" transition:name=`project-subtitle-${project.slug}`>
                    {projectData.description}
                </p>
            </div>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-8 mt-8">
            {
                projectData.images.map((photo, index) => (
                        <>
                            <div class="overflow-hidden">
                                <Image
                                        id=`${project.slug}-${index}`
                                        src={photo as unknown as string}
                                        alt=""
                                        class="preview object-conver hover:scale-[1.02] transition-transform"
                                        transition:name=`media-image-${project.slug}-${index}`
                                        width="500"
                                        height="500"
                                        quality={90}

                                />
                            </div>


                            <div id=`${project.slug}-${index}-modal`
                                 class="fixed inset-0 h-full p-12 z-[100] backdrop-blur-sm hidden items-center justify-center bg-black/50 modal">
                                <Image
                                        src={photo as unknown as string}
                                        alt=""
                                        transition:name=`media-image-${project.slug}-${index}`
                                        width="900"
                                        height="1200"
                                        class="max-h-full object-contain"
                                        quality={100}
                                />
                            </div>
                        </>
                ))
            }
        </section>
    </div>
</Layout>


<script>
    if (document) {
        document.addEventListener('astro:page-load', () => {
            const button = document.getElementById('go-back-button');
            const allImages = document.querySelectorAll('img.preview')

            allImages.forEach((image) => {
                image.addEventListener('click', (event) => {
                    const modalId = (event.target as HTMLElement).id + '-modal'
                    const modal = document.getElementById(modalId)

                    if (!modal.hasAttribute('data-listener')) {
                        modal.addEventListener('click', () => {
                            toggleModal(modalId, false)
                        })
                        modal.setAttribute('data-listener', 'true')
                    }

                    toggleModal(modalId, true)
                })
            })

            if (!button) {
                return
            }

            button.addEventListener('click', () => {
                window.history.back()
            })
        })
    }

    function toggleModal(modalId: string, show: boolean = true) {
        const modal = document.getElementById(modalId)

        if (show) {
            modal.classList.add('flex')
            modal.classList.remove('hidden')
            document.body.classList.add('overflow-hidden')
            animateModal(modal)
        } else {
            animateModal(modal, false)

            setTimeout(() => {
                modal.classList.add('hidden')
                modal.classList.remove('flex')
                document.body.classList.remove('overflow-hidden')
            }, 300)

        }
    }

    // write a function which animates the modal in and out when the image is clicked using the WA API
    function animateModal(modal: HTMLElement, show: boolean = true) {
        modal.animate({
            opacity: show ? [0, 1] : [1, 0]
        }, {
            duration: 350,
            easing: 'ease-in-out',
            fill: 'forwards'
        })
    }
</script>
